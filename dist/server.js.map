{"version":3,"sources":["../src/server.js"],"names":[],"mappings":"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","file":"server.js","sourcesContent":["\"use strict\";\n\nimport {MongoClient} from './MongoClient.js';\nimport colUtil from './collectionUtil.js';\n\nconst http = require(\"http\")\nconst _ = require(\"underscore\")\nconst util = require('./utilities.js')\nconst url = 'mongodb://localhost:27017/hey-pi'\nconst DBClient = new MongoClient();\n\n//TODO: make sure user only queries for one doc when doing POST\n\nDBClient.connect(url)\n.then((db) => {\n\tDBClient.setDB(db);\n\tconsole.log(\"database loaded\");\n});\n\nfunction getData(path) {\n\n\tvar promise = new Promise ((resolve, reject) => {\n\n\t\tpropagateQuery(path).then((resolveObj) => {\n\n\t\t\tvar collection = resolveObj.collection;\n\t\t\tvar mongoQuery = resolveObj.mongoQuery;\n\n\t\t\tcollection.find(mongoQuery).toArray((err, docs) => {\n\n\t\t\t\tif (docs !== undefined && docs !== null && docs.length > 0) {\n\t\t\t\t\tdocs = util.sanitizeId(docs);\n\t\t\t\t}\n\n\t\t\t\tif (err) reject({\"code\": 500, \"body\": err});\n\n\t\t\t\tvar responseData = {\"code\": 200, \"body\": docs};\n\t\t\t\tresolve(responseData);\n\t\t\t});\n\n\t\t}, (err) => {\n\t\t\tvar responseData = {\"code\": 500, \"body\": err};\n\t\t\treject(responseData);\n\t\t});\n\t});\n\treturn promise;\n}\n\nfunction delData(path){\n\n\tvar promise = new Promise ((resolve, reject) => {\n\n\t\tpropagateQuery(path).then((resolveObj) => {\n\n\t\t\tvar collection = resolveObj.collection;\n\t\t\tvar mongoQuery = resolveObj.mongoQuery;\n\n\t\t\tcollection.deleteMany(mongoQuery, (err, result) => {\n\t\t\t\tif (err) reject ({\"code\": 500, \"body\": err});\n\n\t\t\t\tvar numDocsDeleted = result.deletedCount;\n\t\t\t\tvar responseData = {\"code\": 200, \"body\": \"Deleteted \"+numDocsDeleted+\" documents.\"};\n\t\t\t\tresolve(responseData);\n\t\t\t});\n\t\t}, (err) => {\n\t\t\tvar responseData = {\"code\": 500, \"body\": err};\n\t\t\treject(responseData);\n\t\t});\n\t});\n\treturn promise;\n}\n\nfunction propagateQuery(path) {\n\n\tvar pathArray = [];\n\tif (path.length % 2 === 1 ) path.push(\"\");\n\n\t\t// load client\n\tvar promise = new Promise(\n\t\t(resolve, reject) => {\n\n\t\t\tfor (var i = 0; i < path.length; i += 2) {\n\t\t\t\t\tpathArray.push([path[i], path[i + 1]]);\n\t\t\t}\n\n\t\t\tvar chain = pathArray.reduce((previous, item, index, array)=> {\n\n\t\t\t\t return previous.then((result) => {\n\t\t\t\t\t var collectionName = item[0];\n\t\t\t\t\t var query = item[1];\n\t\t\t\t\t var mongoQuery = util.parseQuery(query);\n\n\t\t\t\t\t if (mongoQuery === null) {\n\t\t\t\t\t\t reject(\"bad request\");\n\t\t\t\t\t }\n\t\t\t\t\t mongoQuery = _.extend(mongoQuery,result.fkQuery);\n\n\t\t\t\t\t var promise = new Promise (\n\t\t\t\t\t\t (resolve, reject) => {\n\t\t\t\t\t\t DBClient.loadCollection(collectionName)\n\t\t\t\t\t\t .then((collection) => {\n\t\t\t\t\t\t\tif (index !== (pathArray.length-1)){\n\t\t\t\t\t\t\t\tvar cursor = collection.find(mongoQuery);\n\t\t\t\t\t\t\t\tconsole.log('got into if')\n\t\t\t\t\t\t\t\tcursor.toArray((err, docs) => {\n\t\t\t\t\t\t\t\t\t if (err) {\n\t\t\t\t\t\t\t\t\t\t reject(err);\n\t\t\t\t\t\t\t\t\t } else {\n\t\t\t\t\t\t\t\t\t\t var keys = _.pluck(docs,\"_id\");\n\n\t\t\t\t\t\t\t\t\t\t for (var i = 0; i < keys.length; i++) {\n\t\t\t\t\t\t\t\t\t\t\t keys[i] = keys[i].toString();\n\t\t\t\t\t\t\t\t\t\t };\n\n\t\t\t\t\t\t\t\t\t\t var fkFieldName = collectionName + \"id\";\n\t\t\t\t\t\t\t\t\t\t var fkQuery = {};\n\t\t\t\t\t\t\t\t\t\t fkQuery[fkFieldName] = { $in: keys };\n\t\t\t\t\t\t\t\t\t\tresolve({doc: docs, fkQuery: fkQuery});\n\n\t\t\t\t\t\t\t\t\t }\n\t\t\t\t\t\t\t\t })\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\n\t\t\t\t\t\t\t\tvar resolveObj = {};\n\t\t\t\t\t\t\t\tresolveObj[\"collection\"] = collection;\n\t\t\t\t\t\t\t\tresolveObj[\"mongoQuery\"] = mongoQuery;\n\t\t\t\t\t\t\t\tresolve(resolveObj);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t });\n\t\t\t\t\t });\n\t\t\t\t\t return promise;\n\t\t\t\t });\n\t\t\t}, new Promise(\n\t\t\t\t(resolve, reject) => { //initial value given to reduce\n\t\t\t\t\tvar result = {};\n\t\t\t\t\tresult[\"fkQuery\"] = {};\n\t\t\t\t\tresolve(result);\n\t\t\t\t})\n\t\t\t);\n\n\t\tchain.then((cursor) => {\n\t\t\t\t//var responseData = {\"code\": 200, \"body\": result.doc};\n\t\t\t\tresolve(cursor);\n\t\t\t}, (err) => {\n\t\t\t\tconsole.log('got into error clause after chain is finished' + err);\n\t\t\t\t//var responseData = {\"code\": 500, \"body\": err};\n\t\t\t\treject(err);\n\t\t});\n\t});\n\treturn promise;\n}\n\nfunction saveData(path, data) {\n\tconsole.log('in save data');\n\tvar collectionName = path[0];\n\n\tvar promise = new Promise(\n\t\t(resolve, reject) => {\n\n\t\t\tDBClient.connect(url)\n\t\t\t.then((db) => {\n\t\t\t\tDBClient.setDB(db);\n\t\t\t\treturn DBClient.loadCollection(collectionName);\n\t\t\t})\n\n\t\t\t.then((collection) => {\n\t\t\t\tconsole.log('loading collection');\n\n\t\t\t\treturn saveDataHelper(collection);\n\t\t\t})\n\n\t\t\t.then((docs) => {\n\n\t\t\t\tdocs = util.sanitizeId(docs);\n\t\t\t\tvar responseData = {\"code\": 201, \"body\": docs};\n\t\t\t\tresolve(responseData);\n\t\t\t},(err) => {\n\t\t\t\tvar responseData = {\"code\": 500, \"body\": err.message};\n\t\t\t\tconsole.log(\"response data is: \"+ responseData)\n\t\t\t\tresolve(responseData);\n\t\t\t});\n\t\t}\n\t);\n\n\treturn promise;\n\n\n\tfunction saveDataHelper(collection){\n\n\t\tif (path.length > 1) {\n\t\t\tvar mongoQuery = util.parseQuery(path[1]);\n\t\t}\n\n\t\tif (path.length === 1){\n\t\t\tvar promise = new Promise(\n\t\t\t\t(resolve, reject) => {\n\t\t\t\t\tcollection.insertOne(data, function(err, result){\n\t\t\t\t\t\tif (err){\n\t\t\t\t  \t  \t\treject(err);\n\t\t\t\t  \t  \t}\n\t\t\t\t  \t  \telse{\n\t\t\t\t  \t  \t\tresolve(result.ops[0]);\n\t\t\t\t  \t  \t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t);\n\t\t\treturn promise;\n\t\t}\n\n\t\telse if (path.length == 2) {\n\t\t\t//TODO: need to take this out into its own function!!!\n\n\t\t\tvar promise = new Promise(\n\t\t\t\t(resolve, reject) => {\n\t\t\t\t\tcolUtil.updateOne(collection, mongoQuery, data)\n\t\t\t\t\t.then((result) => {\n\t\t\t\t\t\tresolve(result)\n\n\t\t\t\t\t}, (err) => {\n\t\t\t\t\t\treject(err);\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t);\n\t\t\treturn promise;\n\t\t}\n\n\n\t\telse if (path.length === 3){\n\t\t\tvar collectionToAddTo = path[2];\n\t\t\tvar parentID;\n\n\t\t\tvar promise = new Promise(\n\t\t\t\t(resolve, reject) => {\n\t\t\t\t\tcolUtil.findOne(collection, mongoQuery)\n\n\t\t\t\t\t.then((doc) => {\n\t\t\t\t\t\tparentID = doc._id.toString();\n\t\t\t\t\t\treturn DBClient.loadCollection(collectionToAddTo);\n\t\t\t\t\t})\n\n\t\t\t\t\t.then((collectionToAddToObj) => {\n\t\t\t\t\t\tvar obj = {};\n\t\t\t\t\t\tvar keyName = collectionName + \"id\";\n\t\t\t\t\t\tobj[keyName] = parentID;\n\t\t\t\t\t\tdata = _.extend(data, obj);\n\t\t\t\t\t\treturn colUtil.insertOne(collectionToAddToObj, data);\n\t\t\t\t\t})\n\n\t\t\t\t\t.then((result) => {\n\t\t\t\t\t\tdebugger;\n\t\t\t\t\t\tresolve(result.ops[0]);\n\t\t\t\t\t},(err) => {\n\t\t\t\t\t\treject(err);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t);\n\t\t\treturn promise;\n\n\t\t}\n\t\telse{\n\n\t\t}\n\t}\n\n\tfunction updateSchema(data){\n\t\tvar keys = Object.keys(data);\n\n\t\tDBClient.loadCollection(\"schemas\")\n\t\t.then((schemaCollection) => {\n\t\t\tvar result = schemaCollection.find({\"collectionName\":collectionName});\n\t\t\tresult.forEach(function(doc){\n\n\t\t\t\tif( doc != null) {\n\t\t\t\t\tvar diff = _.difference(keys,doc.fields);\n\n\t\t\t\t\tif (diff.length > 0) {\n\t\t\t\t\t\tdoc.fields = diff.concat(doc.fields);\n\t\t\t\t\t\tschemaCollection.updateOne({\"collectionName\":collectionName},\n\t\t\t\t\t\t{$set: {\"fields\":doc.fields}},  function(err) {\n\n\t\t\t\t\t\t\tif (err) throw err;\n\t\t\t\t\t\t\tconsole.log(\"Schema updated\")\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}, (err) => {console.log(err);});\n\t}\n}\n\n\nvar server = http.createServer(function(req, resp) {\n\n\tresp.setHeader('Access-Control-Allow-Origin', '*');\n\tresp.setHeader('Access-Control-Request-Method', '*');\n\tresp.setHeader('Access-Control-Allow-Methods', 'OPTIONS, GET, POST, PUT, DELETE');\n\tresp.setHeader('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept, Key');\n\tif ( req.method === 'OPTIONS' ) {\n\t\tresp.writeHead(200);\n\t\tresp.end();\n\t\treturn;\n\t}\n\n\tif (req.url.match(/^\\/api/) !== null ){\n\n\t\tvar path = util.stripPath(req.url);\n\t\tvar data = \"\";\n\n\t\tif (path.length === 0) {\n\t\t\tresp.writeHead(200, {\n\t\t\t\t'Content-Length': 17,\n\t\t\t\t'Content-Type': 'text/plain'\n\t\t\t});\n\n\t\t\tresp.write('Welcome to hey-pi');\n\t\t\tresp.end();\n\t\t}\n\n\t\tswitch(req.method){\n\n\t\t\tcase \"GET\":\n\n\t\t\t\tgetData(path).then((response) => {\n\n\t\t\t\t\tvar responseStr = JSON.stringify(response.body);\n\n\t\t\t\t\tresp.writeHead(response.code, {\n\t\t\t\t\t\t'Content-Length': responseStr.length,\n\t\t\t\t\t\t'Content-Type': 'application/json'\n\t\t\t\t\t});\n\n\t\t\t\t\tresp.write(responseStr);\n\t\t\t\t\tresp.end();\n\n\t\t\t\t},(err) => {\n\n\t\t\t\t\tresp.writeHead(err.code, {\n\t\t\t\t\t\t'Content-Length': err.body.length,\n\t\t\t\t\t\t'Content-Type': 'text/plain'\n\t\t\t\t\t})\n\t\t\t\t\tresp.write(err.body);\n\t\t\t\t\tresp.end();\n\t\t\t\t});\n\n\n\t\t\t\tbreak;\n\n\t\t\tcase \"POST\":\n\n\t\t\t\treq.on('data', function(chunk){\n\t\t\t\t\tdata+=chunk;\n\t\t\t\t});\n\n\t\t\t\treq.on('end', function(){\n\t\t\t\t\tdata = JSON.parse(data);\n\t\t\t\t\tsaveData(path, data).then((responseData) => {\n\n\t\t\t\t\t\tvar respString = JSON.stringify(responseData.body);\n\n\t\t\t\t\t\tresp.writeHead(responseData.code, {\n\t\t\t\t\t\t\t'Content-Length': respString.length,\n\t\t\t\t\t\t\t'Content-Type': 'application/json'\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tresp.write(respString);\n\t\t\t\t\t\tresp.end();\n\n\t\t\t\t\t}, (err) => {\n\t\t\t\t\t\tresp.writeHead(err.code, {\n\t\t\t\t\t\t\t'Content-Length': err.body.length,\n\t\t\t\t\t\t\t'Content-Type': 'text/plain'\n\t\t\t\t\t\t})\n\t\t\t\t\t\tresp.write(err.body);\n\t\t\t\t\t\tresp.end();\n\t\t\t\t\t});\n\n\t\t\t\t});\n\t\t\t\tbreak;\n\n\t\t\tcase \"DELETE\":\n\n\t\t\t\tdelData(path).then((responseData) => {\n\n\t\t\t\t\tvar respString = JSON.stringify(responseData.body);\n\n\t\t\t\t\tresp.writeHead(responseData.code, {\n\t\t\t\t\t\t'Content-Length': respString.length,\n\t\t\t\t\t\t'Content-Type': 'application/json'\n\t\t\t\t\t})\n\t\t\t\t\tresp.write(respString);\n\t\t\t\t\tresp.end();\n\n\t\t\t\t},(err) => {\n\n\t\t\t\t\tresp.writeHead(err.code, {\n\t\t\t\t\t\t'Content-Length': err.body.length,\n\t\t\t\t\t\t'Content-Type': 'text/plain'\n\t\t\t\t\t})\n\t\t\t\t\tresp.write(err.body);\n\t\t\t\t\tresp.end();\n\t\t\t\t});\n\n\n\t\t\t\tbreak;\n\t\t}\n\t} else {\n\t\tresp.writeHead(400, {\n\t\t\t'Content-Length': 15,\n\t\t\t'Content-Type': 'text/plain'\n\t\t});\n\t\tresp.write('route not found');\n\t\tresp.end();\n\t}\n\n});\n\nserver.listen(8000, function(){\n\tconsole.log(\"Server listening on: http://localhost:8000\");\n});\n"]}