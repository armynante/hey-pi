{"version":3,"sources":["../../src/routes/guests.js"],"names":[],"mappings":"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","file":"guests.js","sourcesContent":["import express from 'express'\nimport Mongo from '../server.js';\nimport {User} from '../models/user.js';\nimport config from '../config.js';\nimport utilities from '../utilities.js';\nimport jwt from 'jsonwebtoken';\nimport bodyParser from 'body-parser';\nimport bcrypt from 'bcryptjs';\nimport { ObjectID } from \"mongodb\";\n\nvar router = express.Router();\n\n\nrouter.post('/',(req,res) => {\n  var guest = new User(req.body.email);\n  guest.isGuest = true;\n  guest.usersId = req.user._id;\n  guest.setPassword(req.body.pass).then(()=> {\n    return guest.save();\n  })\n  .then((resp) => {\n    var html = '';\n    var emailSubject = '';\n    if (req.body.htmlEmailMessage !== null && req.body.htmlEmailMessage !== '') {\n      html = req.body.htmlEmailMessage;\n    }\n    if (req.body.emailSubject !== null && req.body.emailSubject !== '') {\n      emailSubject = req.body.emailSubject;\n    }\n    html += \"<br><p>please click on the link to confirm account<p></br><a href='http://hey-pi.com/confirm?token=\"+ resp.message.token + \"'>confirm account...</a>\";\n    utilities.sendEmail(guest.email, emailSubject, html);\n    res.status(resp.code).json(resp.message);\n  })\n\t.catch((err) => {\n\t\tres.status(err.code).json(err);\n\t})\n});\n\nrouter.post('/authorize',(req,res) => {\n\tvar email = req.body.email || req.query.email;\n\tvar pass = req.body.pass || req.query.pass;\n\n\tvar user = { \"email\": email, \"pass\": pass};\n\t//find user and test pass\n\tMongo._getData(['users','email_is_' + email]).then((resp) => {\n\t\t//if we get a match\n\t\tif (resp.message.length) {\n\t\t\tvar user = resp.message[0];\n\t\t\t//test the password\n\t\t\tbcrypt.compare(pass, user.password, (err,valid) => {\n\t\t\t\tif(valid) {\n\t\t\t\t\tvar token = jwt.sign(user, config.secret, {\n\t\t\t\t\t\texpiresIn: \"30d\" //24r\n\t\t\t\t\t});\n\n\t\t\t\t\tuser['token'] = token;\n\t\t\t\t\tdelete user['pass'];\n\t\t\t\t\tuser['authorized'] = true;\n\t\t\t\t\tres.json(user);\n\n\t\t\t\t} else {\n\t\t\t\t\tres.status(401).json({success: false, message:\"password incorrect\"});\n\t\t\t\t}\n\n\t\t\t});\n\t\t} else {\n\t\t\tres.status(404).json({success: false, message:\"no user found with that email\"});\n\t\t}\n\t})\n\t.catch((err) => {\n    console.log(err);\n\t\tres.status(500).json(err)\n\t});\n});\n\nrouter.get('/', (req, res) => {\n \tMongo._get('users',{'usersId' : req.user._id}).then((resp) => {\n      req.user.reads++;\n      Mongo._update('users',{'_id':req.user._id}, req.user);\n\t\t\tres.status(200).json(resp);\n\t\t})\n\t\t.catch((err) => {\n      console.log(err);\n\t\t\tres.json(err);\n\t\t});\n\t});\n\nrouter.get('/:userId', (req, res) => {\n  try {\n    var id = new ObjectID(req.params.userId);\n  } catch (e) {\n    res.status(500).json({message:\"Error parsing id. Please check too see if the id is valid.\"});\n  }\n\n \tMongo._get('users',{'usersId' : req.user._id, \"_id\":id}).then((resp) => {\n      req.user.reads++;\n      Mongo._update('users',{'_id':req.user._id}, req.user);\n\t\t\tres.status(200).json(resp);\n\t\t})\n\t\t.catch((err) => {\n      console.log(err);\n\t\t\tres.json(err);\n\t\t});\n\t});\n\nrouter.put('/:userId', (req, res) => {\n\n  try {\n\n    var id = new ObjectID(req.params.userId);\n\n    if (req.body._id !== undefined) {\n      req.body._id = new ObjectID(req.body._id);\n    }\n\n  } catch (e) {\n    res.status(500).json({message:\"Error parsing id. Please check too see if the id is valid.\"});\n  }\n  console.log(req.user._id);\n \tMongo._update('users',{\"_id\":id},req.body).then((resp) => {\n      req.user.writes++;\n      Mongo._update('users',{'_id':req.user._id}, req.user);\n      console.log(resp);\n\t\t\tres.status(200).json({\"success\":true,\"message\":\"guest record updated\"});\n\t\t})\n\t\t.catch((err) => {\n      res.status(err.message.code).json({message: err.message.message});\n\t\t});\n\t});\n\n\n\nexport default router\n"]}